<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Highlights JSON Generator – Raw Array</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body.dark-mode {background:#121212;color:#eee;}
    .json-box {white-space:pre-wrap;font-family:monospace;background:#f8f9fa;padding:1rem;border-radius:.5rem;min-height:150px;overflow-x:auto;}
    body.dark-mode .json-box {background:#1e1e1e;color:#eee;}
    .floating-buttons {position:fixed;top:50%;right:20px;transform:translateY(-50%);display:flex;flex-direction:column;gap:10px;z-index:1000;}
    .container {max-width:900px;margin:auto;}
    .popup-alert {position:fixed;bottom:20px;right:20px;background:#0d6efd;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.3);opacity:0;transition:opacity .3s;z-index:2000;}
    .popup-alert.show {opacity:1;}
    textarea#matchInput {min-height:500px !important; font-family:monospace; font-size:0.95rem;}
  </style>
</head>
<body>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Highlights JSON Generator</h2>
    <button id="themeToggle" class="btn btn-secondary">Dark Theme</button>
  </div>

  <div class="mb-3">
    <label for="dateInput" class="form-label">Date (default today)</label>
    <input type="date" id="dateInput" class="form-control">
  </div>

  <div class="mb-3">
    <label for="manualCategory" class="form-label">Manual Category (applies to all)</label>
    <input type="text" id="manualCategory" class="form-control" placeholder="e.g. UCL, EFL, Friendly, FA Cup">
  </div>

  <div class="mb-3">
    <label class="form-label">Paste all matches (one per line)</label>
    <textarea id="matchInput" class="form-control" placeholder="Arsenal vs Crystal Palace , EPL , https://...
Arsenal vs Wrexham , , https://...
Real Madrid vs Barcelona , LaLiga , https://...
Bayern vs Dortmund , , https://..."></textarea>
  </div>

  <div class="mb-4">
    <h5>Generated JSON (Raw Array)</h5>
    <div id="jsonOutput" class="json-box"></div>
  </div>

  <div class="mb-4">
    <h5>Current Match Data (Only Matches)</h5>
    <div id="currentDataOutput" class="json-box"></div>
  </div>
</div>

<div class="floating-buttons">
  <button id="generateBtn" class="btn btn-primary">Generate JSON</button>
  <button id="copyJsonBtn" class="btn btn-outline-secondary">Copy JSON</button>
  <button id="copyMatchesBtn" class="btn btn-outline-info">Copy Match List</button>
</div>

<div id="popupAlert" class="popup-alert"></div>

<script>
/* ---------- Popup Alert ---------- */
const popup = document.getElementById('popupAlert');
function show(msg) {
  popup.textContent = msg;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 2000);
}

/* ---------- Set Today's Date Properly ---------- */
function setTodayDate() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;
  document.getElementById('dateInput').value = todayStr;
}

// Always set today when page loads (overrides any saved stale date)
window.addEventListener('load', () => {
  setTodayDate();

  // Load saved data (but date is overridden with today)
  const savedInput = localStorage.getItem('lastInput');
  const savedJson = localStorage.getItem('lastJson');
  const savedCat = localStorage.getItem('manualCategory');
  const savedMatchList = localStorage.getItem('lastMatchList');
  const savedTheme = localStorage.getItem('theme');

  if (savedInput) document.getElementById('matchInput').value = savedInput;
  if (savedJson) document.getElementById('jsonOutput').textContent = savedJson;
  if (savedCat) document.getElementById('manualCategory').value = savedCat;
  if (savedMatchList) document.getElementById('currentDataOutput').textContent = savedMatchList;

  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
    document.getElementById('themeToggle').textContent = 'Light Theme';
  }
});

/* ---------- Elements ---------- */
const dateInput = document.getElementById('dateInput');
const manualCategoryEl = document.getElementById('manualCategory');
const jsonOutput = document.getElementById('jsonOutput');
const currentDataOutput = document.getElementById('currentDataOutput');

/* ---------- Random ID ---------- */
const used = new Set();
function rndId() {
  const a = 'abcdefghijklmnopqrstuvwxyz';
  let id;
  do {
    id = a[Math.floor(Math.random()*26)] + a[Math.floor(Math.random()*26)] + a[Math.floor(Math.random()*26)] + Math.floor(1000000 + Math.random()*9000000);
  } while (used.has(id));
  used.add(id);
  return id;
}

/* ---------- League Map (2025-26 Season) ---------- */
const leagueMap = {
  // EPL
  'arsenal':'EPL','chelsea':'EPL','liverpool':'EPL','manchester city':'EPL','man city':'EPL','manchester united':'EPL','man utd':'EPL','tottenham':'EPL','aston villa':'EPL','newcastle':'EPL','west ham':'EPL','brighton':'EPL','crystal palace':'EPL','wolverhampton':'EPL','wolves':'EPL','everton':'EPL','fulham':'EPL','brentford':'EPL','nottingham forest':'EPL','bournemouth':'EPL','southampton':'EPL',
  // Serie A
  'juventus':'Serie A','inter':'Serie A','milan':'Serie A','ac milan':'Serie A','napoli':'Serie A','roma':'Serie A','lazio':'Serie A','atalanta':'Serie A','fiorentina':'Serie A','torino':'Serie A','bologna':'Serie A','udinese':'Serie A','sassuolo':'Serie A','empoli':'Serie A','monza':'Serie A','lecce':'Serie A','verona':'Serie A','cagliari':'Serie A','genoa':'Serie A','parma':'Serie A','como':'Serie A','venezia':'Serie A',
  // LaLiga
  'real madrid':'LaLiga','barcelona':'LaLiga','atletico madrid':'LaLiga','atlético madrid':'LaLiga','sevilla':'LaLiga','real sociedad':'LaLiga','villarreal':'LaLiga','athletic bilbao':'LaLiga','real betis':'LaLiga','osassuna':'LaLiga','rayo vallecano':'LaLiga','mallorca':'LaLiga','celta vigo':'LaLiga','valencia':'LaLiga','getafe':'LaLiga','girona':'LaLiga','espanyol':'LaLiga','leganés':'LaLiga','las palmas':'LaLiga','alaves':'LaLiga','deportivo alavés':'LaLiga',
  // Bundesliga
  'bayern munich':'Bundesliga','bayern':'Bundesliga','borussia dortmund':'Bundesliga','dortmund':'Bundesliga','rb leipzig':'Bundesliga','leipzig':'Bundesliga','union berlin':'Bundesliga','freiburg':'Bundesliga','bayer leverkusen':'Bundesliga','leverkusen':'Bundesliga','wolfsburg':'Bundesliga','mainz 05':'Bundesliga','mainz':'Bundesliga','borussia mönchengladbach':'Bundesliga','gladbach':'Bundesliga','köln':'Bundesliga','cologne':'Bundesliga','eintracht frankfurt':'Bundesliga','frankfurt':'Bundesliga','stuttgart':'Bundesliga','bochum':'Bundesliga','augsburg':'Bundesliga','heidenheim':'Bundesliga',
  // Ligue 1
  'paris saint-germain':'Ligue 1','psg':'Ligue 1','monaco':'Ligue 1','marseille':'Ligue 1','olympique marseille':'Ligue 1','lyon':'Ligue 1','olympique lyonnais':'Ligue 1','lille':'Ligue 1','nice':'Ligue 1','rennes':'Ligue 1','lens':'Ligue 1','brest':'Ligue 1','montpellier':'Ligue 1','toulouse':'Ligue 1','nantes':'Ligue 1','strasbourg':'Ligue 1','reims':'Ligue 1','le havre':'Ligue 1','metz':'Ligue 1','angers':'Ligue 1',
  // MLS
  'lafc':'MLS','los angeles fc':'MLS','la galaxy':'MLS','inter miami':'MLS','atlanta united':'MLS','nashville sc':'MLS','philadelphia union':'MLS','fc cincinnati':'MLS','cincinnati':'MLS','columbus crew':'MLS','orlando city':'MLS','new york city fc':'MLS','nycfc':'MLS','ny red bulls':'MLS','red bulls':'MLS','seattle sounders':'MLS','portland timbers':'MLS','sporting kansas city':'MLS','sporting kc':'MLS','austin fc':'MLS','charlotte fc':'MLS','chicago fire':'MLS','houston dynamo':'MLS','real salt lake':'MLS','st. louis city sc':'MLS',
  // Saudi Pro League
  'al hilal':'Saudi Pro League','al nassr':'Saudi Pro League','al ittihad':'Saudi Pro League','al ahli':'Saudi Pro League','al shabab':'Saudi Pro League'
};

/* ---------- Guess League ---------- */
function getTeamLeague(team) {
  const t = team.toLowerCase();
  for (const key in leagueMap) {
    if (t.includes(key)) return leagueMap[key];
  }
  return null;
}

function guessLeague(t1, t2) {
  const l1 = getTeamLeague(t1);
  const l2 = getTeamLeague(t2);
  if (l1 && l2 && l1 === l2) return l1;
  if (l1) return l1;
  if (l2) return l2;
  return 'Football';
}

/* ---------- Parse Matches ---------- */
function parseAll(text, date, manualCat = '') {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  const result = [];
  const matchNames = [];

  for (const line of lines) {
    const parts = line.split(',').map(p => p.trim());
    if (parts.length < 2) continue;

    const url = parts.pop();
    const rest = parts.join(',').trim();
    const matchAndLeague = rest.split(/\s*,\s*/);

    let matchStr, explicitLeague = '';
    if (matchAndLeague.length === 1) {
      matchStr = matchAndLeague[0];
    } else {
      matchStr = matchAndLeague.slice(0, -1).join(',');
      explicitLeague = matchAndLeague[matchAndLeague.length - 1];
    }

    const [team1, team2] = matchStr.split(' vs ').map(t => t.trim());
    if (!team1 || !team2 || !url) continue;

    const finalLeague = manualCat || explicitLeague || guessLeague(team1, team2);

    result.push({
      id: rndId(),
      team1,
      team2,
      category: finalLeague,
      date,
      link: `https://cricfoot.pages.dev/yt?url=${url}`
    });

    matchNames.push(`${team1} vs ${team2}`);
  }

  return { result, matchNames };
}

/* ---------- Generate JSON ---------- */
document.getElementById('generateBtn').onclick = () => {
  used.clear();
  const txt = document.getElementById('matchInput').value.trim();
  const d = dateInput.value; // Already today's date by default
  const manualCat = manualCategoryEl.value.trim();

  if (!txt) {
    jsonOutput.textContent = '';
    currentDataOutput.textContent = '';
    show('No input');
    return;
  }

  const { result, matchNames } = parseAll(txt, d, manualCat);

  if (!result.length) {
    jsonOutput.textContent = '';
    currentDataOutput.textContent = '';
    show('No valid matches');
    return;
  }

  // Raw array format with comma after each object, including last + extra comma
  const jsonLines = result.map((obj, i) => {
    const str = JSON.stringify(obj, null, 2);
    return str + (i < result.length - 1 ? ',' : ',');
  });

  const outputJson = jsonLines.join('\n') + '\n';

  jsonOutput.textContent = outputJson;
  currentDataOutput.textContent = matchNames.join('\n');

  // Save everything to localStorage
  localStorage.setItem('lastInput', txt);
  localStorage.setItem('lastJson', outputJson);
  localStorage.setItem('lastDate', d); // Still save in case user changed it
  localStorage.setItem('manualCategory', manualCat);
  localStorage.setItem('lastMatchList', matchNames.join('\n'));

  show('Generated & Saved!');
};

/* ---------- Copy Buttons ---------- */
document.getElementById('copyJsonBtn').onclick = () => {
  const txt = jsonOutput.textContent.trim();
  if (!txt) { show('Nothing to copy'); return; }
  navigator.clipboard.writeText(txt).then(() => show('JSON Copied!')).catch(() => show('Copy failed'));
};

document.getElementById('copyMatchesBtn').onclick = () => {
  const txt = currentDataOutput.textContent.trim();
  if (!txt) { show('No matches'); return; }
  navigator.clipboard.writeText(txt).then(() => show('Match List Copied!')).catch(() => show('Copy failed'));
};

/* ---------- Theme Toggle ---------- */
document.getElementById('themeToggle').onclick = () => {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('themeToggle').textContent = isDark ? 'Light Theme' : 'Dark Theme';
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
