<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cricket Highlights Post Extractor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      white-space: normal;
      font-family: monospace;
      color: #1e293b;
      vertical-align: middle;
    }
    tbody tr:hover {
      background-color: #f0f9ff;
    }
    .date {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 700; /* made bold */
      font-style: normal; /* removed italic */
    }
    a {
      color: #2563eb;
      text-decoration: underline;
    }
    a:hover {
      color: #1d4ed8;
    }
    .copy-button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 0.35rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-left: 1rem;
      white-space: nowrap;
    }
    .copy-button:hover {
      background-color: #1e40af;
    }
    .row-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .text-container {
      flex-grow: 1;
      min-width: 0;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <div class="w-full max-w-4xl">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">Cricket Highlights Post Extractor</h1>
    <input
      type="text"
      id="blogUrl"
      value="https://www.crichighlightsvidz.com"
      placeholder="Enter Blogger URL (e.g., https://www.crichighlightsvidz.com)"
      class="w-full p-4 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-600 text-gray-700 mb-4"
    />
    <input
      type="text"
      id="searchBar"
      placeholder="Search posts by title..."
      class="w-full p-4 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-600 text-gray-700 mb-6"
    />

    <table id="postTable" class="bg-white rounded-lg shadow-md">
      <tbody></tbody>
    </table>

    <p id="error" class="text-red-500 text-center mt-6 text-lg"></p>
  </div>

  <script>
    let allPosts = [];

    function trimTitle(title) {
      let stopIndex = title.search(/\b(\d|ODI|Test|T20|Highlights|20\d{2})\b/i);
      if (stopIndex === -1) return title.trim();
      return title.slice(0, stopIndex).trim();
    }

    function formatDateWithRelative(dateStr) {
      const date = new Date(dateStr);
      if (isNaN(date)) return "No date available";

      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      const formattedDate = date.toLocaleDateString('en-US', options);

      const now = new Date();
      const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
      const utcNow = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());

      const diffDays = Math.floor((utcNow - utcDate) / (1000 * 60 * 60 * 24));

      let relativeText = "";
      if (diffDays === 0) {
        relativeText = " - Today";
      } else if (diffDays === 1) {
        relativeText = " - Yesterday";
      } else if (diffDays > 1) {
        relativeText = ` - ${diffDays} days ago`;
      }
      return formattedDate + relativeText;
    }

    async function fetchPosts() {
      const blogUrl = document.getElementById('blogUrl').value.trim();
      const errorElement = document.getElementById('error');
      const postTableBody = document.querySelector('#postTable tbody');

      postTableBody.innerHTML = '';
      errorElement.textContent = '';
      allPosts = [];

      if (!blogUrl) {
        errorElement.textContent = 'Please enter a valid Blogger URL';
        return;
      }

      try {
        const CORS_PROXY = "https://corsproxy.io/?url=";
        const feedUrl = `${CORS_PROXY}https://${new URL(blogUrl).hostname}/feeds/posts/default?alt=json&max-results=150`;
        const response = await fetch(feedUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        const entries = data.feed?.entry || [];
        if (entries.length === 0) {
          errorElement.textContent = 'No posts found or feed is empty';
          return;
        }

        allPosts = entries
          .map(entry => {
            // If category array exists, check for "tour of" term - skip if found
            if (entry.category && Array.isArray(entry.category)) {
              const hasTourOf = entry.category.some(cat =>
                cat.term && cat.term.toLowerCase().includes("tour of")
              );
              if (hasTourOf) {
                return null; // skip this post entirely
              }
            }

            // Get trimmed title from category term if exists, else fallback to trimmed full title
            let matchTitle = 'No title';
            if (entry.category && Array.isArray(entry.category) && entry.category.length > 0) {
              matchTitle = entry.category[0].term || 'No title';
            } else {
              const rawTitle = entry.title?.$t || 'No title';
              matchTitle = trimTitle(rawTitle);
            }

            const publishedDate = entry.published?.$t ? formatDateWithRelative(entry.published.$t) : 'No date available';

            let iframeUrl = 'No iframe found';
            const content = entry.content?.$t || '';
            const iframeMatch = content.match(/<iframe[^>]+src=["'](.*?)["']/i);
            if (iframeMatch && iframeMatch[1]) {
              let url = iframeMatch[1];
              url = url.replace(/\?rel=0/, '');
              const youtubeMatch = url.match(/https:\/\/www\.youtube\.com\/embed\/([^\/?]+)/i);
              if (youtubeMatch && youtubeMatch[1]) {
                iframeUrl = `https://hlsplayers.pages.dev/yt?url=${youtubeMatch[1]}`;
              } else {
                iframeUrl = url;
              }
            }

            return { title: matchTitle, publishedDate, iframeUrl };
          })
          .filter(post => post !== null); // Remove null entries filtered above

        renderPosts(allPosts);
      } catch (error) {
        errorElement.textContent = `Error fetching posts: ${error.message}. Ensure the CORS proxy is working or try a server-side solution. Serve the page over HTTPS or localhost to avoid JavaScript execution errors.`;
        console.error('Fetch error:', error);
      }
    }

    function renderPosts(posts) {
      const postTableBody = document.querySelector('#postTable tbody');
      postTableBody.innerHTML = '';

      posts.forEach((post) => {
        const tr = document.createElement('tr');
        const td = document.createElement('td');

        const textToCopy = `[ ${post.title}, cricket, ${post.iframeUrl} ]`;

        const iframeLink = `<a href="${post.iframeUrl}" target="_blank" rel="noopener noreferrer">${post.iframeUrl}</a>`;

        td.innerHTML = `
          <div class="row-content">
            <div class="text-container"> ${post.title}, Cricket, ${iframeLink} <span class="date">${post.publishedDate}</span></div>
            <button class="copy-button" data-copy-text="${textToCopy}" aria-label="Copy to clipboard">Copy</button>
          </div>
        `;

        tr.appendChild(td);
        postTableBody.appendChild(tr);
      });

      document.querySelectorAll('.copy-button').forEach(button => {
        button.addEventListener('click', () => {
          const text = button.getAttribute('data-copy-text');
          navigator.clipboard.writeText(text).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          }).catch(err => {
            alert('Failed to copy text to clipboard.');
            console.error('Copy error:', err);
          });
        });
      });
    }

    document.getElementById('searchBar').addEventListener('input', e => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredPosts = allPosts.filter(post => post.title.toLowerCase().includes(searchTerm));
      renderPosts(filteredPosts);
    });

    document.addEventListener('DOMContentLoaded', fetchPosts);
  </script>
</body>
</html>
