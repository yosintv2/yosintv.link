
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PPV.to Live Matches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    pre { background:#f3f4f6; padding:12px; border-radius:10px; font-size:13.5px; }
  </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

  <div class="container mx-auto p-6 max-w-5xl">
    <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">PPV.to Live Sports Today</h1>

    <div class="mb-8 flex flex-col sm:flex-row gap-4 items-center">
      <input type="text" id="search" placeholder="Search matches, league or team..."
        class="w-full sm:flex-1 px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <label class="flex items-center cursor-pointer">
        <input type="checkbox" id="showCompleted" class="mr-3 h-5 w-5 text-blue-600" />
        <span class="text-gray-700">Show ended matches</span>
      </label>
    </div>

    <div id="loading" class="text-center text-gray-500 text-lg">Loading events...</div>
    <div id="error" class="text-center text-red-500 hidden"></div>
    <div id="matches" class="space-y-6 hidden"></div>
  </div>

  <div id="toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 opacity-0 transition-opacity">
    Copied!
  </div>

  <script>
    let allEvents = [];
    let countdownIntervals = {};

    async function fetchEvents() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const container = document.getElementById('matches');

      try {
        const res = await fetch('https://api.ppv.to/api/streams');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        allEvents = [];
        json.streams.forEach(cat => {
          cat.streams.forEach(s => {
            if (s.always_live || !s.starts_at) return;
            allEvents.push({
              ...s,
              category: cat.category_name || 'Other'
            });
          });
        });

        if (allEvents.length === 0) throw new Error('No events found');

        renderMatches(filterMatches());
        loading.classList.add('hidden');
        container.classList.remove('hidden');
      } catch (e) {
        loading.classList.add('hidden');
        error.textContent = `Error: ${e.message}`;
        error.classList.remove('hidden');
      }
    }

    function filterMatches() {
      const query = document.getElementById('search').value.toLowerCase();
      const showEnded = document.getElementById('showCompleted').checked;
      const now = Math.floor(Date.now() / 1000);

      return allEvents.filter(e => {
        if (!showEnded && now > e.ends_at) return false;
        return e.name.toLowerCase().includes(query) ||
               e.category.toLowerCase().includes(query) ||
               (e.tag && e.tag.toLowerCase().includes(query));
      });
    }

    function renderMatches(events) {
      const container = document.getElementById('matches');
      container.innerHTML = '';
      Object.values(countdownIntervals).forEach(clearInterval);
      countdownIntervals = {};

      events.forEach(stream => {
        const matchName = stream.name.replace(/\s*-\s*/g, ' vs ').trim();
        const fullTitle = `${matchName}`;

        // Detect sport → choose correct player page
        const isCricket = /cricket/i.test(stream.category) || /cricket/i.test(stream.tag || '');
        const playerBase = isCricket 
          ? 'https://yosintv2.github.io/ads/cric.html' 
          : 'https://yosintv2.github.io/ads/foot.html';

        // Get the raw iframe URL (main or first substream)
        const rawIframe = stream.iframe || 
          (stream.substreams && stream.substreams[0] && stream.substreams[0].iframe) || 
          '';

        // This is exactly what you wanted:
        const playerLink = rawIframe ? `${playerBase}?url=${rawIframe}` : '';

        const jsonData = {
          name: fullTitle,
          links: [
            "https://yosintv2.github.io/ads/foot.html?url=https://ytvlive.pages.dev/play7?m=______ ",                                      // Link 1
            "https://yosintv-api.pages.dev/api/ads",        // Ad link
            playerLink,                                      // Link 3 → same as link 1
            "________________blv_links___________"
          ]
        };

        // Card
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow';

        const titleRow = document.createElement('div');
        titleRow.className = 'flex items-center justify-between mb-3';
        const title = document.createElement('h2');
        title.className = 'text-xl font-bold text-gray-900';
        title.textContent = fullTitle;
        const copyNameBtn = document.createElement('button');
        copyNameBtn.textContent = 'Copy Title';
        copyNameBtn.className = 'bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm font-medium';
        copyNameBtn.onclick = () => copyToClipboard(fullTitle);
        titleRow.append(title, copyNameBtn);

        const countdown = document.createElement('div');
        countdown.className = 'text-lg font-medium text-orange-600 mb-4';
        startCountdown(stream.starts_at, stream.ends_at, countdown);

        const info = document.createElement('div');
        info.className = 'text-sm text-gray-600 italic mb-4';
        info.textContent = [stream.category, stream.tag].filter(Boolean).join(' • ') || 'Live Event';

        // JSON Block
        const jsonBlock = document.createElement('div');
        jsonBlock.className = 'bg-gray-50 rounded-lg p-4';
        const jsonTitle = document.createElement('div');
        jsonTitle.textContent = `${fullTitle}`;
        jsonTitle.className = 'font-bold text-gray-800 mb-2';
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(jsonData, null, 2);
        const copyJsonBtn = document.createElement('button');
        copyJsonBtn.textContent = 'Copy JSON';
        copyJsonBtn.className = 'mt-3 bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-medium';
        copyJsonBtn.onclick = () => copyToClipboard(JSON.stringify(jsonData, null, 2));

        jsonBlock.append(jsonTitle, pre, copyJsonBtn);

        card.append(titleRow, countdown, info, jsonBlock);
        container.appendChild(card);
      });
    }

    function startCountdown(startTs, endTs, el) {
      const update = () => {
        const now = Math.floor(Date.now() / 1000);
        if (now < startTs) {
          el.textContent = `Starts in: ${fmt(startTs - now)}`;
          el.className = 'text-lg font-medium text-orange-600 mb-4';
        } else if (now <= endTs) {
          el.textContent = `LIVE – ends in: ${fmt(endTs - now)}`;
          el.className = 'text-lg font-bold text-red-600 mb-4 animate-pulse';
        } else {
          el.textContent = 'Match Ended';
          el.className = 'text-lg font-medium text-gray-500 mb-4';
        }
      };
      const fmt = s => {
        const d = Math.floor(s / 86400);
        const h = Math.floor((s % 86400) / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return `${d?d+'d ':''}${h}h ${m}m ${sec}s`;
      };
      update();
      const id = setInterval(update, 1000);
      countdownIntervals[el] = id;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        const toast = document.getElementById('toast');
        toast.classList.remove('opacity-0');
        setTimeout(() => toast.classList.add('opacity-0'), 1800);
      });
    }

    document.getElementById('search').addEventListener('input', () => renderMatches(filterMatches()));
    document.getElementById('showCompleted').addEventListener('change', () => renderMatches(filterMatches()));

    window.onload = fetchEvents;
  </script>
</body>
</html>
